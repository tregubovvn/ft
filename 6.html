<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formula Builder — Проверка знаний формул</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0f1a;
            --bg-secondary: #111827;
            --fg: #f1f5f9;
            --muted: #64748b;
            --accent: #22d3ee;
            --accent-dim: rgba(34, 211, 238, 0.15);
            --success: #10b981;
            --error: #ef4444;
            --card: rgba(17, 24, 39, 0.8);
            --border: rgba(100, 116, 139, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Space Grotesk', sans-serif; background: var(--bg); color: var(--fg); min-height: 100vh; overflow-x: hidden; }
        .bg-mesh { position: fixed; inset: 0; z-index: -1; background: radial-gradient(ellipse 80% 50% at 20% 20%, rgba(34, 211, 238, 0.08) 0%, transparent 50%), radial-gradient(ellipse 60% 40% at 80% 80%, rgba(139, 92, 246, 0.06) 0%, transparent 50%); }
        .grid-overlay { position: fixed; inset: 0; z-index: -1; background-image: linear-gradient(rgba(34, 211, 238, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(34, 211, 238, 0.03) 1px, transparent 1px); background-size: 60px 60px; mask-image: radial-gradient(ellipse at center, black 30%, transparent 70%); }
        .screen { display: none; opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease, transform 0.5s ease; }
        .screen.active { display: block; opacity: 1; transform: translateY(0); }
        .title-display { font-family: 'JetBrains Mono', monospace; font-weight: 600; letter-spacing: -0.02em; }
        .formula-title-card { background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(17, 24, 39, 0.6) 100%); border: 1px solid var(--border); border-radius: 16px; padding: 2.5rem; position: relative; overflow: hidden; text-align: center; }
        .formula-title-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--accent), transparent); opacity: 0.5; }
        .formula-name-display { font-size: 2rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem; }
        .formula-hint { font-size: 1rem; color: var(--muted); margin-top: 1rem; }
        .symbols-container { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border); text-align: left; }
        .symbols-title { font-size: 0.875rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; font-weight: 600; }
        .symbol-item { display: flex; align-items: center; gap: 1rem; padding: 0.6rem 0; border-bottom: 1px solid rgba(100, 116, 139, 0.1); }
        .symbol-item:last-child { border-bottom: none; }
        .symbol-char { min-width: 60px; font-family: 'JetBrains Mono', monospace; color: var(--accent); text-align: left; font-weight: 500; }
        .symbol-dash { color: var(--muted); }
        .symbol-name { color: var(--fg); flex: 1; }
        .fragment { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1.25rem; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 12px; cursor: grab; user-select: none; transition: all 0.2s ease; font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; position: relative; overflow: hidden; }
        .fragment::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, var(--accent-dim), transparent); opacity: 0; transition: opacity 0.2s ease; }
        .fragment:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--accent-dim); }
        .fragment:hover::before { opacity: 1; }
        .fragment:active { cursor: grabbing; transform: scale(0.95); }
        .fragment.dragging { opacity: 0.5; transform: scale(0.95); }
        .fragment.placed { background: var(--accent-dim); border-color: var(--accent); }
        .fragment.correct { background: rgba(16, 185, 129, 0.2); border-color: var(--success); animation: correctPulse 0.5s ease; }
        .fragment.incorrect { background: rgba(239, 68, 68, 0.2); border-color: var(--error); animation: shake 0.4s ease; }
        @keyframes correctPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
        .drop-zone { min-height: 100px; border: 2px dashed var(--border); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 0.5rem; padding: 1rem; transition: all 0.3s ease; background: rgba(17, 24, 39, 0.3); }
        .drop-zone.drag-over { border-color: var(--accent); background: var(--accent-dim); box-shadow: inset 0 0 30px rgba(34, 211, 238, 0.1); }
        .drop-zone.has-items { border-style: solid; border-color: var(--muted); }
        .progress-bar { height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #8b5cf6); border-radius: 3px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
        .progress-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.875rem 1.75rem; border-radius: 12px; font-family: 'Space Grotesk', sans-serif; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; border: none; position: relative; overflow: hidden; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #06b6d4); color: var(--bg); box-shadow: 0 4px 16px rgba(34, 211, 238, 0.3); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(34, 211, 238, 0.4); }
        .btn-secondary { background: var(--bg-secondary); color: var(--fg); border: 2px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent); background: var(--accent-dim); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .input-field { width: 100%; padding: 1rem 1.25rem; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 12px; color: var(--fg); font-family: 'Space Grotesk', sans-serif; font-size: 1rem; transition: all 0.2s ease; }
        .input-field:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-dim); }
        .input-field::placeholder { color: var(--muted); }
        .card { background: var(--card); backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 20px; padding: 2rem; }
        .stat-card { text-align: center; padding: 1.5rem; background: linear-gradient(135deg, var(--bg-secondary), rgba(17, 24, 39, 0.5)); border-radius: 16px; border: 1px solid var(--border); }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--accent), #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .qr-modal { position: fixed; inset: 0; background: rgba(10, 15, 26, 0.95); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(8px); }
        .qr-modal.active { display: flex; }
        .qr-content { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 20px; padding: 2rem; max-width: 500px; width: 90%; }
        video { width: 100%; border-radius: 12px; background: var(--bg); }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .stagger-1 { animation-delay: 0.1s; } .stagger-2 { animation-delay: 0.2s; } .stagger-3 { animation-delay: 0.3s; } .stagger-4 { animation-delay: 0.4s; }
        @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; } }
        .hint-text { color: var(--muted); font-size: 0.875rem; }
        .file-drop { border: 2px dashed var(--border); border-radius: 16px; padding: 3rem; text-align: center; transition: all 0.3s ease; cursor: pointer; }
        .file-drop:hover, .file-drop.drag-over { border-color: var(--accent); background: var(--accent-dim); }
        .url-input-group { display: flex; gap: 0.75rem; } .url-input-group input { flex: 1; }
        .score-circle { width: 160px; height: 160px; border-radius: 50%; background: conic-gradient(var(--accent) calc(var(--score) * 3.6deg), var(--bg-secondary) calc(var(--score) * 3.6deg)); display: flex; align-items: center; justify-content: center; position: relative; }
        .score-circle::before { content: ''; position: absolute; inset: 12px; background: var(--bg-secondary); border-radius: 50%; }
        .score-value { position: relative; z-index: 1; font-family: 'JetBrains Mono', monospace; font-size: 3rem; font-weight: 700; }
        .katex { font-size: 1.3em; }
        .fragments-container { display: flex; flex-wrap: wrap; gap: 0.75rem; justify-content: center; padding: 1rem; }
        .action-buttons { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; }
        .result-formula { padding: 1rem; border-radius: 12px; margin-top: 0.75rem; }
        .result-formula.correct { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); }
        .result-formula.incorrect { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); }
        .validation-message { text-align: center; margin-top: 1rem; font-size: 0.875rem; color: var(--error); min-height: 1.5rem; transition: opacity 0.3s ease; }
        .timer-display { font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; color: var(--accent); font-weight: 600; }
        .result-time { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; color: var(--fg); margin-top: 0.5rem; }
        .submission-status { margin-top: 1.5rem; padding: 0.75rem 1.25rem; border-radius: 8px; font-size: 0.875rem; display: inline-flex; align-items: center; gap: 0.5rem; }
        .submission-status.success { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: var(--success); }
        @media (max-width: 640px) { .card { padding: 1.25rem; } .fragment { padding: 0.5rem 0.875rem; font-size: 0.95rem; } .stat-value { font-size: 1.75rem; } .score-circle { width: 120px; height: 120px; } .score-value { font-size: 2rem; } .formula-name-display { font-size: 1.5rem; } .formula-title-card { padding: 1.5rem; } }
    </style>
</head>
<body>
    <div class="bg-mesh"></div>
    <div class="grid-overlay"></div>

    <div id="welcomeScreen" class="screen active">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="card max-w-lg w-full fade-in">
                <div class="text-center mb-8">
                    <h1 class="title-display text-4xl md:text-5xl font-bold mb-3">Formula<span style="color: var(--accent)">Builder</span></h1>
                    <p class="text-lg" style="color: var(--muted)">Проверка знаний формул</p>
                </div>
                <div class="space-y-6">
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium mb-2" style="color: var(--muted)">Фамилия</label><input type="text" id="lastName" class="input-field" placeholder="Иванов"></div>
                        <div><label class="block text-sm font-medium mb-2" style="color: var(--muted)">Имя</label><input type="text" id="firstName" class="input-field" placeholder="Иван"></div>
                    </div>
                    <div class="pt-4 border-t" style="border-color: var(--border)">
                        <p class="text-sm font-medium mb-3" style="color: var(--muted)">Загрузить формулы</p>
                        <div class="space-y-3">
                            <div id="fileDropZone" class="file-drop">
                                <svg class="mx-auto mb-3" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="color: var(--muted"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
                                <p style="color: var(--muted)">Перетащите XML файл сюда</p>
                                <p class="text-sm mt-1" style="color: var(--border)">или нажмите для выбора</p>
                                <input type="file" id="fileInput" accept=".xml" class="hidden">
                            </div>
                            <div class="url-input-group">
                                <input type="url" id="urlInput" class="input-field" placeholder="Ссылка (Яндекс.Диск или URL)">
                                <button id="loadUrlBtn" class="btn btn-secondary whitespace-nowrap">Загрузить</button>
                            </div>
                            <div class="flex gap-2">
                                <button id="scanQrBtn" class="btn btn-secondary flex-1">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5z"/><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75zM6.75 16.5h.75v.75h-.75v-.75zM16.5 6.75h.75v.75h-.75v-.75zM13.5 13.5h.75v.75h-.75v-.75zM13.5 19.5h.75v.75h-.75v-.75zM19.5 13.5h.75v.75h-.75v-.75zM19.5 19.5h.75v.75h-.75v-.75zM16.5 16.5h.75v.75h-.75v-.75z"/></svg>
                                    Сканировать QR
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="formulasStatus" class="hidden p-3 rounded-lg" style="background: var(--accent-dim)"><p class="text-sm text-center">Загружено формул: <span id="formulasCount" class="font-bold">0</span></p></div>
                    <div>
                        <button id="startBtn" class="btn btn-primary w-full text-lg" disabled>Начать тест<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3"/></svg></button>
                        <div id="validationMessage" class="validation-message"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mainScreen" class="screen">
        <div class="min-h-screen p-4 py-8">
            <div class="max-w-3xl mx-auto">
                <div class="mb-6 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <div><p class="text-sm" style="color: var(--muted)">Студент</p><p id="studentName" class="font-semibold"></p></div>
                        <div class="text-center"><p class="text-sm" style="color: var(--muted)">Время</p><p id="timerDisplay" class="timer-display">00:00</p></div>
                        <div class="text-right"><p class="text-sm" style="color: var(--muted)">Формула</p><p id="formulaCounter" class="font-semibold title-display"></p></div>
                    </div>
                    <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
                </div>
                <div class="card mb-6 fade-in stagger-1">
                    <div class="formula-title-card">
                        <p class="text-sm uppercase tracking-wider mb-2" style="color: var(--muted)">Соберите формулу</p>
                        <h4 id="formulaName" class="formula-name-display"></h4>
                        <p class="formula-hint">Расставьте фрагменты в правильном порядке</p>
                        <div id="symbolsContainer" class="symbols-container" style="display: none;"></div>
                    </div>
                </div>
                <div class="card mb-6 fade-in stagger-2">
                    <p class="text-sm font-medium mb-3" style="color: var(--muted)">Ваш ответ (перетащите фрагменты)</p>
                    <div id="dropZone" class="drop-zone"><p class="hint-text">Перетащите фрагменты сюда в правильном порядке</p></div>
                </div>
                <div class="card mb-6 fade-in stagger-3">
                    <p class="text-sm font-medium mb-3" style="color: var(--muted)">Доступные фрагменты</p>
                    <div id="fragmentsContainer" class="fragments-container"></div>
                </div>
                <div class="action-buttons fade-in stagger-4">
                    <button id="resetBtn" class="btn btn-secondary"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"/></svg>Сбросить</button>
                    <button id="checkBtn" class="btn btn-primary" disabled><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>Проверить</button>
                </div>
            </div>
        </div>
    </div>

    <div id="resultScreen" class="screen">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="card max-w-2xl w-full text-center fade-in">
                <h2 class="title-display text-3xl md:text-4xl font-bold mb-2">Результат</h2>
                <p id="resultStudentName" class="text-lg mb-6" style="color: var(--muted)"></p>
                <div class="mb-6"><p class="text-sm uppercase tracking-wider" style="color: var(--muted)">Время прохождения</p><p id="resultTime" class="result-time">00:00</p></div>
                <div class="flex justify-center mb-8"><div class="score-circle" id="scoreCircle" style="--score: 0"><span class="score-value" id="scoreValue">0%</span></div></div>
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="stat-card"><p class="stat-value" id="totalFormulas">0</p><p class="text-sm" style="color: var(--muted)">Всего формул</p></div>
                    <div class="stat-card"><p class="stat-value" id="correctAnswers">0</p><p class="text-sm" style="color: var(--muted)">Правильных</p></div>
                    <div class="stat-card"><p class="stat-value" id="wrongAnswers">0</p><p class="text-sm" style="color: var(--muted)">Ошибок</p></div>
                </div>
                <div id="submissionStatus" class="submission-status success" style="display: none;"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Результаты отправлены</div>
                <div id="resultsDetails" class="text-left mb-8 max-h-64 overflow-y-auto"></div>
                <div class="flex gap-4 justify-center"><button id="restartBtn" class="btn btn-primary"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"/></svg>Начать заново</button></div>
            </div>
        </div>
    </div>

    <div id="qrModal" class="qr-modal">
        <div class="qr-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="title-display text-xl font-bold">Сканирование QR</h3>
                <button id="closeQrBtn" class="btn btn-secondary" style="padding: 0.5rem"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <video id="qrVideo" playsinline></video>
            <canvas id="qrCanvas" class="hidden"></canvas>
            <p id="qrStatus" class="text-center mt-4" style="color: var(--muted)">Наведите камеру на QR-код</p>
        </div>
    </div>

    <script>
        // ============ STATE ============
        let formulas = [];
        let currentFormulaIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let results = [];
        let currentFragments = [];
        let placedFragments = [];
        let studentData = { firstName: '', lastName: '' };
        let resultFormUrl = null; 
        let testStartTime = 0;
        let timerInterval = null;
        let totalTestTime = 0;

        // ============ DOM ELEMENTS ============
        const screens = { welcome: document.getElementById('welcomeScreen'), main: document.getElementById('mainScreen'), result: document.getElementById('resultScreen') };
        const elements = {
            lastName: document.getElementById('lastName'), firstName: document.getElementById('firstName'), fileDropZone: document.getElementById('fileDropZone'),
            fileInput: document.getElementById('fileInput'), urlInput: document.getElementById('urlInput'), loadUrlBtn: document.getElementById('loadUrlBtn'),
            scanQrBtn: document.getElementById('scanQrBtn'), formulasStatus: document.getElementById('formulasStatus'), formulasCount: document.getElementById('formulasCount'),
            startBtn: document.getElementById('startBtn'), validationMessage: document.getElementById('validationMessage'), studentName: document.getElementById('studentName'),
            formulaCounter: document.getElementById('formulaCounter'), progressFill: document.getElementById('progressFill'), formulaName: document.getElementById('formulaName'),
            dropZone: document.getElementById('dropZone'), fragmentsContainer: document.getElementById('fragmentsContainer'), resetBtn: document.getElementById('resetBtn'),
            checkBtn: document.getElementById('checkBtn'), resultStudentName: document.getElementById('resultStudentName'), resultTime: document.getElementById('resultTime'),
            scoreCircle: document.getElementById('scoreCircle'), scoreValue: document.getElementById('scoreValue'), totalFormulas: document.getElementById('totalFormulas'),
            correctAnswers: document.getElementById('correctAnswers'), wrongAnswers: document.getElementById('wrongAnswers'), resultsDetails: document.getElementById('resultsDetails'),
            restartBtn: document.getElementById('restartBtn'), qrModal: document.getElementById('qrModal'), qrVideo: document.getElementById('qrVideo'),
            qrCanvas: document.getElementById('qrCanvas'), qrStatus: document.getElementById('qrStatus'), closeQrBtn: document.getElementById('closeQrBtn'),
            timerDisplay: document.getElementById('timerDisplay'), symbolsContainer: document.getElementById('symbolsContainer'), submissionStatus: document.getElementById('submissionStatus')
        };

        // ============ UTILITIES ============
        function showScreen(screenName) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[screenName].classList.add('active'); }
        function formatTime(ms) { const totalSeconds = Math.floor(ms / 1000); const minutes = Math.floor(totalSeconds / 60); const seconds = totalSeconds % 60; return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; }
        
        function parseLatexToFragments(latex) {
            const tokens = []; let current = ''; let braceDepth = 0; let i = 0;
            while (i < latex.length) {
                const char = latex[i];
                if (char === '\\') {
                    if (current.trim()) { tokens.push(current.trim()); current = ''; }
                    let cmd = '\\'; i++;
                    while (i < latex.length && /[a-zA-Z]/.test(latex[i])) { cmd += latex[i]; i++; }
                    if (cmd === '\\left' || cmd === '\\right') { if (i < latex.length) { cmd += latex[i]; i++; } }
                    tokens.push(cmd); continue;
                }
                if (char === '{') { braceDepth++; current += char; i++; continue; }
                if (char === '}') {
                    braceDepth--; current += char; i++;
                    if (braceDepth === 0 && current.trim()) { tokens.push(current.trim()); current = ''; }
                    continue;
                }
                if (braceDepth > 0) { current += char; i++; continue; }
                if (['+', '-', '=', '^', '_', '(', ')', '[', ']', '!', ',', ';', ':'].includes(char)) {
                    if (current.trim()) { tokens.push(current.trim()); current = ''; }
                    tokens.push(char); i++; continue;
                }
                if (/\s/.test(char)) { if (current.trim()) { tokens.push(current.trim()); current = ''; } i++; continue; }
                current += char; i++;
            }
            if (current.trim()) { tokens.push(current.trim()); }
            const fragments = [];
            for (let j = 0; j < tokens.length; j++) {
                const token = tokens[j];
                if (token === '\\frac') {
                    let fracStr = token; let depth = 0; let k = j + 1; let partCount = 0;
                    while (k < tokens.length && partCount < 2) {
                        if (tokens[k] === '{') { if (depth === 0) fracStr += '{'; else fracStr += tokens[k]; depth++; }
                        else if (tokens[k] === '}') { depth--; if (depth === 0) { fracStr += '}'; partCount++; } else { fracStr += tokens[k]; } }
                        else { fracStr += tokens[k]; }
                        k++;
                    }
                    fragments.push(fracStr); j = k - 1; continue;
                }
                if (token === '\\sqrt') {
                    let sqrtStr = token; let k = j + 1;
                    if (k < tokens.length && tokens[k] === '{') { let depth = 0; while (k < tokens.length) { if (tokens[k] === '{') depth++; else if (tokens[k] === '}') depth--; sqrtStr += tokens[k]; k++; if (depth === 0) break; } }
                    fragments.push(sqrtStr); j = k - 1; continue;
                }
                if (token === '^') {
                    let last = fragments.pop() || ''; let powerStr = token; let k = j + 1;
                    if (k < tokens.length && tokens[k] === '{') { let depth = 0; while (k < tokens.length) { if (tokens[k] === '{') depth++; else if (tokens[k] === '}') depth--; powerStr += tokens[k]; k++; if (depth === 0) break; } }
                    else if (k < tokens.length) { powerStr += tokens[k]; k++; }
                    fragments.push(last + powerStr); j = k - 1; continue;
                }
                if (token === '_') {
                    let last = fragments.pop() || ''; let subStr = token; let k = j + 1;
                    if (k < tokens.length && tokens[k] === '{') { let depth = 0; while (k < tokens.length) { if (tokens[k] === '{') depth++; else if (tokens[k] === '}') depth--; subStr += tokens[k]; k++; if (depth === 0) break; } }
                    else if (k < tokens.length) { subStr += tokens[k]; k++; }
                    fragments.push(last + subStr); j = k - 1; continue;
                }
                if (token.startsWith('\\left')) {
                    let bracketStr = token; let depth = 1; let k = j + 1;
                    while (k < tokens.length && depth > 0) { if (tokens[k].startsWith('\\left')) depth++; else if (tokens[k].startsWith('\\right')) depth--; bracketStr += tokens[k]; k++; }
                    fragments.push(bracketStr); j = k - 1; continue;
                }
                fragments.push(token);
            }
            return fragments.filter(f => f.trim());
        }
        
        function shuffleArray(array) { const shuffled = [...array]; for (let i = shuffled.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]; } return shuffled; }
        function renderLatexInline(latex) { try { return katex.renderToString(latex, { throwOnError: false }); } catch (e) { return latex; } }
        function renderLatexDisplay(latex, element) { try { katex.render(latex, element, { throwOnError: false, displayMode: true }); } catch (e) { element.textContent = latex; } }

        // ============ TIMER ============
        function startTimer() { testStartTime = Date.now(); timerInterval = setInterval(() => { const elapsed = Date.now() - testStartTime; elements.timerDisplay.textContent = formatTime(elapsed); }, 1000); }
        function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } totalTestTime = Date.now() - testStartTime; return totalTestTime; }

        // ============ FORMULA HANDLING ============
        function loadFormulas(xmlString) {
            const parser = new DOMParser(); const xmlDoc = parser.parseFromString(xmlString, 'text/xml'); const formulaElements = xmlDoc.querySelectorAll('formula');
            formulas = [];
            formulaElements.forEach(f => {
                const name = f.getAttribute('name') || 'Формула';
                const latexNode = f.querySelector('latex'); let latex = ''; if (latexNode) { latex = latexNode.textContent.trim(); } else { latex = f.textContent.trim(); }
                const symbols = []; const symbolsNode = f.querySelector('symbols');
                if (symbolsNode) { const symbolNodes = symbolsNode.querySelectorAll('symbol'); symbolNodes.forEach(s => { symbols.push({ char: s.getAttribute('char') || '', name: s.getAttribute('name') || '' }); }); }
                if (latex) { formulas.push({ name, latex, symbols }); }
            });
            if (formulas.length > 0) { elements.formulasStatus.classList.remove('hidden'); elements.formulasCount.textContent = formulas.length; updateStartButton(); }
        }

        function loadCurrentFormula() {
            if (currentFormulaIndex >= formulas.length) { showResults(); return; }
            const formula = formulas[currentFormulaIndex];
            elements.formulaName.textContent = formula.name; elements.formulaCounter.textContent = `${currentFormulaIndex + 1} / ${formulas.length}`; elements.progressFill.style.width = `${(currentFormulaIndex / formulas.length) * 100}%`;
            currentFragments = parseLatexToFragments(formula.latex); placedFragments = [];
            renderSymbols(formula.symbols); renderFragments(); resetDropZone();
        }

        function renderSymbols(symbols) {
            if (!symbols || symbols.length === 0) { elements.symbolsContainer.style.display = 'none'; elements.symbolsContainer.innerHTML = ''; return; }
            elements.symbolsContainer.style.display = 'block'; let html = '<p class="symbols-title">Условные обозначения</p>';
            symbols.forEach(s => { html += `<div class="symbol-item"><div class="symbol-char">${renderLatexInline(s.char)}</div><div class="symbol-dash">—</div><div class="symbol-name">${renderLatexInline(s.name)}</div></div>`; });
            elements.symbolsContainer.innerHTML = html;
        }

        function renderFragments() {
            const shuffled = shuffleArray(currentFragments); elements.fragmentsContainer.innerHTML = '';
            shuffled.forEach((fragment, index) => {
                const el = document.createElement('div'); el.className = 'fragment'; el.draggable = true; el.dataset.fragment = fragment; el.dataset.index = index; el.innerHTML = renderLatexInline(fragment);
                el.addEventListener('dragstart', handleDragStart); el.addEventListener('dragend', handleDragEnd); el.addEventListener('click', handleFragmentClick);
                elements.fragmentsContainer.appendChild(el);
            });
        }

        function resetDropZone() { elements.dropZone.innerHTML = '<p class="hint-text">Перетащите фрагменты сюда в правильном порядке</p>'; elements.dropZone.classList.remove('has-items'); placedFragments = []; updateCheckButton(); }
        function updateCheckButton() { elements.checkBtn.disabled = placedFragments.length !== currentFragments.length; }
        function updateStartButton() {
            const lastNameVal = elements.lastName.value.trim(); const firstNameVal = elements.firstName.value.trim(); const hasName = lastNameVal && firstNameVal; const hasFormulas = formulas.length > 0;
            elements.startBtn.disabled = !(hasName && hasFormulas);
            let message = ''; if (!hasFormulas && !hasName) { message = 'Введите имя, фамилию и загрузите формулы'; } else if (!hasName) { message = 'Введите фамилию и имя для начала теста'; } else if (!hasFormulas) { message = 'Загрузите формулы для начала теста'; }
            elements.validationMessage.textContent = message; elements.validationMessage.style.opacity = message ? '1' : '0';
        }
        
        function showUploadStatus(message, type) {
            elements.validationMessage.textContent = message;
            elements.validationMessage.style.opacity = '1';
            if (type === 'error') elements.validationMessage.style.color = 'var(--error)';
            else if (type === 'success') elements.validationMessage.style.color = 'var(--success)';
            else elements.validationMessage.style.color = 'var(--accent)'; // loading or default
        }

        // ============ DRAG AND DROP ============
        let draggedElement = null;
        function handleDragStart(e) { draggedElement = e.target.closest('.fragment'); if (draggedElement) { draggedElement.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; } }
        function handleDragEnd(e) { if (draggedElement) { draggedElement.classList.remove('dragging'); draggedElement = null; } }
        function handleFragmentClick(e) {
            const fragment = e.target.closest('.fragment'); if (!fragment) return;
            if (elements.dropZone.contains(fragment)) {
                elements.fragmentsContainer.appendChild(fragment); fragment.classList.remove('placed');
                placedFragments = placedFragments.filter(f => f !== fragment.dataset.fragment);
                if (placedFragments.length === 0) { elements.dropZone.innerHTML = '<p class="hint-text">Перетащите фрагменты сюда в правильном порядке</p>'; elements.dropZone.classList.remove('has-items'); }
            } else {
                const hint = elements.dropZone.querySelector('.hint-text'); if (hint) hint.remove();
                elements.dropZone.appendChild(fragment); fragment.classList.add('placed'); elements.dropZone.classList.add('has-items');
                placedFragments.push(fragment.dataset.fragment);
            }
            updateCheckButton();
        }
        elements.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); elements.dropZone.classList.add('drag-over'); });
        elements.dropZone.addEventListener('dragleave', () => { elements.dropZone.classList.remove('drag-over'); });
        elements.dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); elements.dropZone.classList.remove('drag-over');
            if (draggedElement && !elements.dropZone.contains(draggedElement)) {
                const hint = elements.dropZone.querySelector('.hint-text'); if (hint) hint.remove();
                elements.dropZone.appendChild(draggedElement); draggedElement.classList.add('placed'); elements.dropZone.classList.add('has-items');
                placedFragments.push(draggedElement.dataset.fragment); updateCheckButton();
            }
        });

        // ============ CHECK ANSWER ============
        function checkAnswer() {
            const formula = formulas[currentFormulaIndex]; const correct = currentFragments; const userAnswer = placedFragments;
            const isCorrect = JSON.stringify(correct) === JSON.stringify(userAnswer);
            const result = { name: formula.name, latex: formula.latex, correct: isCorrect, userAnswer: userAnswer.join(' '), correctAnswer: correct.join(' ') };
            results.push(result);
            if (isCorrect) { correctCount++; showFeedback(true); } else { wrongCount++; showFeedback(false); }
            setTimeout(() => { currentFormulaIndex++; loadCurrentFormula(); }, 1500);
        }
        function showFeedback(isCorrect) { const fragments = elements.dropZone.querySelectorAll('.fragment'); fragments.forEach(f => { f.classList.add(isCorrect ? 'correct' : 'incorrect'); }); }

        // ============ RESULTS ============
        function showResults() {
            stopTimer(); const total = formulas.length; const percentage = total > 0 ? Math.round((correctCount / total) * 100) : 0;
            elements.resultStudentName.textContent = `${studentData.lastName} ${studentData.firstName}`; elements.resultTime.textContent = formatTime(totalTestTime);
            elements.totalFormulas.textContent = total; elements.correctAnswers.textContent = correctCount; elements.wrongAnswers.textContent = wrongCount; elements.scoreValue.textContent = `${percentage}%`; elements.scoreCircle.style.setProperty('--score', percentage);
            if (resultFormUrl) { sendResultsToForm(percentage); }
            let detailsHtml = '<div class="space-y-3">';
            results.forEach((r, i) => {
                const icon = r.correct ? '<svg class="inline" width="20" height="20" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>' : '<svg class="inline" width="20" height="20" fill="none" stroke="#ef4444" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>';
                detailsHtml += `<div class="result-formula ${r.correct ? 'correct' : 'incorrect'}"><div class="flex items-center gap-2 mb-2">${icon}<span class="font-medium">${r.name}</span></div><p class="text-sm mb-1" style="color: var(--muted)">Правильный ответ:</p><div class="p-2 rounded" style="background: rgba(0,0,0,0.2)"></div><div id="correctFormula${i}" class="p-2"></div></div>`;
            });
            detailsHtml += '</div>'; elements.resultsDetails.innerHTML = detailsHtml;
            results.forEach((r, i) => { const el = document.getElementById(`correctFormula${i}`); if (el) { renderLatexDisplay(r.latex, el); } });
            showScreen('result');
        }

        function sendResultsToForm(percentage) {
            try {
                const params = new URLSearchParams();
                params.append('student', `${studentData.lastName} ${studentData.firstName}`); params.append('score', `${correctCount}/${formulas.length}`); params.append('percentage', percentage); params.append('time', formatTime(totalTestTime)); params.append('date', new Date().toLocaleString('ru-RU'));
                fetch(`${resultFormUrl}?${params.toString()}`, { method: 'GET', mode: 'no-cors' }).then(() => { elements.submissionStatus.style.display = 'inline-flex'; console.log('Results sent successfully'); }).catch(err => { console.error('Error sending results:', err); });
            } catch (e) { console.error('Error constructing result URL:', e); }
        }

        // ============ QR SCANNER ============
        let videoStream = null; let scanInterval = null;
        async function startQrScanner() {
            elements.qrModal.classList.add('active'); elements.qrStatus.textContent = 'Запрос разрешения камеры...';
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); elements.qrVideo.srcObject = videoStream; await elements.qrVideo.play();
                elements.qrStatus.textContent = 'Наведите камеру на QR-код';
                const canvas = elements.qrCanvas; const ctx = canvas.getContext('2d');
                scanInterval = setInterval(() => {
                    if (elements.qrVideo.readyState !== elements.qrVideo.HAVE_ENOUGH_DATA) return;
                    canvas.width = elements.qrVideo.videoWidth; canvas.height = elements.qrVideo.videoHeight; ctx.drawImage(elements.qrVideo, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height); const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) { elements.qrStatus.textContent = 'QR-код найден!'; elements.urlInput.value = code.data; stopQrScanner(); loadFromUrl(code.data); }
                }, 200);
            } catch (err) { elements.qrStatus.textContent = 'Ошибка доступа к камере: ' + err.message; }
        }
        function stopQrScanner() { if (scanInterval) { clearInterval(scanInterval); scanInterval = null; } if (videoStream) { videoStream.getTracks().forEach(track => track.stop()); videoStream = null; } elements.qrModal.classList.remove('active'); }

        // ============ FILE LOADING ============
        const BASE_PUBLIC_YANDEX_DISK_URL_PREFIX = 'https://cloud-api.yandex.net/v1/disk/public/resources/download?public_key=';

        async function loadFromUrl(url) {
            if (!url) {
                showUploadStatus('Пожалуйста, введите ссылку', 'error');
                return;
            }

            const isYandexDisk = url.includes('yadi.sk') || url.includes('disk.yandex');
            
            elements.loadUrlBtn.disabled = true;
            showUploadStatus('Загрузка...', 'loading');
            
            try {
                let xmlContent = '';

                if (isYandexDisk) {
                    // --- ИСПОЛЬЗУЕМ ПРЕДОСТАВЛЕННЫЙ КОД ДЛЯ ЯНДЕКСА ---
                    
                    // 1. Получаем ссылку для скачивания через API
                    const response = await fetch(BASE_PUBLIC_YANDEX_DISK_URL_PREFIX + encodeURIComponent(url));
                    
                    if (!response.ok) {
                        throw new Error(`Ошибка HTTP: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.href) {
                        throw new Error('Не удалось получить ссылку для скачивания');
                    }
                    
                    // 2. Загружаем файл по полученной ссылке
                    const fileResponse = await fetch(data.href);
                    
                    if (!fileResponse.ok) {
                        throw new Error(`Ошибка загрузки файла: ${fileResponse.status}`);
                    }
                    
                    xmlContent = await fileResponse.text();
                    
                    // Проверяем, что это XML
                    if (!xmlContent.trim().startsWith('<?xml') && !xmlContent.trim().startsWith('<')) {
                        console.warn('Загруженный файл не похож на XML');
                    }

                } else {
                    // --- ЛОГИКА ДЛЯ ДРУГИХ URL (через прокси) ---
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error('Ошибка загрузки по ссылке');
                    xmlContent = await response.text();
                }

                // Обработка контента
                loadFormulas(xmlContent);
                
                if (formulas.length > 0) {
                    showUploadStatus(`Успешно загружено формул: ${formulas.length}`, 'success');
                } else {
                    showUploadStatus('Не удалось найти формулы в файле', 'error');
                }
                
            } catch (error) {
                let errorMessage = error.message;
                
                if (error.message.includes('403')) {
                    errorMessage = 'Ошибка 403: Доступ запрещен. Проверьте права доступа к файлу';
                } else if (error.message.includes('404')) {
                    errorMessage = 'Ошибка 404: Файл не найден. Проверьте ссылку и права доступа';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Ошибка сети. Проверьте подключение или попробуйте другую ссылку.';
                }
                
                showUploadStatus('Ошибка: ' + errorMessage, 'error');
                console.error('Детали ошибки:', error);
            } finally {
                elements.loadUrlBtn.disabled = false;
            }
        }

        function loadFromFile(file) { const reader = new FileReader(); reader.onload = (e) => { loadFormulas(e.target.result); }; reader.readAsText(file); }

        // ============ EVENT HANDLERS ============
        elements.lastName.addEventListener('input', updateStartButton); elements.firstName.addEventListener('input', updateStartButton);
        elements.fileDropZone.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', (e) => { if (e.target.files[0]) loadFromFile(e.target.files[0]); });
        ['dragenter', 'dragover'].forEach(event => { elements.fileDropZone.addEventListener(event, (e) => { e.preventDefault(); elements.fileDropZone.classList.add('drag-over'); }); });
        ['dragleave', 'drop'].forEach(event => { elements.fileDropZone.addEventListener(event, () => { elements.fileDropZone.classList.remove('drag-over'); }); });
        elements.fileDropZone.addEventListener('drop', (e) => { e.preventDefault(); if (e.dataTransfer.files[0]) loadFromFile(e.dataTransfer.files[0]); });
        elements.loadUrlBtn.addEventListener('click', () => { const url = elements.urlInput.value.trim(); if (url) loadFromUrl(url); });
        elements.scanQrBtn.addEventListener('click', startQrScanner); elements.closeQrBtn.addEventListener('click', stopQrScanner);
        elements.startBtn.addEventListener('click', () => {
            studentData.lastName = elements.lastName.value.trim(); studentData.firstName = elements.firstName.value.trim(); elements.studentName.textContent = `${studentData.lastName} ${studentData.firstName}`;
            currentFormulaIndex = 0; correctCount = 0; wrongCount = 0; results = [];
            startTimer(); showScreen('main'); loadCurrentFormula();
        });
        elements.resetBtn.addEventListener('click', () => { renderFragments(); resetDropZone(); });
        elements.checkBtn.addEventListener('click', checkAnswer);
        elements.restartBtn.addEventListener('click', () => {
            showScreen('welcome'); formulas = []; elements.formulasStatus.classList.add('hidden'); elements.lastName.value = ''; elements.firstName.value = ''; elements.urlInput.value = ''; elements.timerDisplay.textContent = '00:00'; elements.symbolsContainer.innerHTML = ''; elements.symbolsContainer.style.display = 'none'; elements.submissionStatus.style.display = 'none'; updateStartButton();
        });

        // ============ URL PARAMETERS ============
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const formulaParam = params.get('formula'); if (formulaParam) { const name = params.get('name') || 'Формула'; formulas.push({ name, latex: decodeURIComponent(formulaParam), symbols: [] }); updateStartButton(); }
            const fileUrl = params.get('file'); if (fileUrl) { loadFromUrl(decodeURIComponent(fileUrl)); }
            const formUrl = params.get('form_url'); if (formUrl) { resultFormUrl = decodeURIComponent(formUrl); }
        }

        // ============ INITIALIZATION ============
        parseUrlParams(); updateStartButton();
    </script>
</body>
</html>